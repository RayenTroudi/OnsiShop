<!DOCTYPE html>
<html>
<head>
    <title>Deep Hero Video Debug</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin: 15px 0; }
        .debug-title { font-weight: bold; color: #495057; margin-bottom: 10px; }
        .debug-content { font-family: monospace; font-size: 12px; white-space: pre-wrap; }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        button { background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <h1>üîç Deep Hero Video Debug</h1>
    
    <button onclick="runFullDiagnostic()">üöÄ Run Full Diagnostic</button>
    <button onclick="testContentAPI()">üì° Test Content API</button>
    <button onclick="inspectHomepage()">üè† Inspect Homepage</button>
    
    <div id="results"></div>

    <script>
        const resultsDiv = document.getElementById('results');
        
        function addSection(title, content, type = 'info') {
            const section = document.createElement('div');
            section.className = `debug-section ${type}`;
            section.innerHTML = `
                <div class="debug-title">${title}</div>
                <div class="debug-content">${content}</div>
            `;
            resultsDiv.appendChild(section);
        }
        
        async function testContentAPI() {
            addSection('üîÑ Testing Content API', 'Fetching content data...');
            
            try {
                const response = await fetch('/api/content');
                const data = await response.json();
                
                if (response.ok && data.success) {
                    const contentData = data.data || {};
                    const heroVideo = contentData['hero_background_video'];
                    
                    let content = `Status: ${response.status} OK\n`;
                    content += `Data keys: ${Object.keys(contentData).length} total\n`;
                    content += `Hero video key: ${heroVideo ? 'EXISTS' : 'MISSING'}\n`;
                    
                    if (heroVideo) {
                        const videoType = heroVideo.startsWith('data:') ? 'Base64 Data URL' : 
                                        heroVideo.startsWith('http') ? 'HTTP URL' : 'Other';
                        content += `Hero video type: ${videoType}\n`;
                        content += `Hero video length: ${heroVideo.length} characters\n`;
                        content += `Hero video preview: ${heroVideo.substring(0, 100)}...\n`;
                        
                        // Test if it's a valid video format
                        const isValidVideo = heroVideo.startsWith('data:video/') || 
                                           heroVideo.startsWith('http') || 
                                           heroVideo.startsWith('/uploads/');
                        
                        if (isValidVideo) {
                            content += `‚úÖ Valid video format detected`;
                            addSection('üìπ Content API Result', content, 'success');
                        } else {
                            content += `‚ùå Invalid video format: ${heroVideo.substring(0, 50)}...`;
                            addSection('üìπ Content API Result', content, 'error');
                        }
                    } else {
                        content += `‚ùå No hero_background_video found in data`;
                        addSection('üìπ Content API Result', content, 'error');
                    }
                    
                    // Show all available keys
                    const allKeys = Object.keys(contentData).join(', ');
                    addSection('üîë Available Content Keys', allKeys);
                    
                } else {
                    addSection('üìπ Content API Error', `Status: ${response.status}\nError: ${data.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                addSection('üìπ Content API Error', `Network error: ${error.message}`, 'error');
            }
        }
        
        async function inspectHomepage() {
            addSection('üîÑ Inspecting Homepage', 'Loading homepage in iframe...');
            
            // Create iframe to load homepage
            const iframe = document.createElement('iframe');
            iframe.src = '/';
            iframe.style.width = '100%';
            iframe.style.height = '400px';
            iframe.style.border = '1px solid #ccc';
            
            iframe.onload = function() {
                setTimeout(() => {
                    try {
                        const doc = this.contentDocument;
                        if (!doc) {
                            addSection('üè† Homepage Inspection', 'Cannot access iframe content (cross-origin)', 'warning');
                            return;
                        }
                        
                        // Check for video elements
                        const videos = doc.querySelectorAll('video');
                        let content = `Video elements found: ${videos.length}\n`;
                        
                        videos.forEach((video, index) => {
                            content += `\nVideo ${index + 1}:\n`;
                            content += `  - src: ${video.src ? (video.src.startsWith('data:') ? 'data URL (cached)' : video.src) : 'No src'}\n`;
                            content += `  - readyState: ${video.readyState}\n`;
                            content += `  - videoWidth: ${video.videoWidth}\n`;
                            content += `  - videoHeight: ${video.videoHeight}\n`;
                            content += `  - duration: ${video.duration || 'unknown'}\n`;
                            content += `  - paused: ${video.paused}\n`;
                            content += `  - muted: ${video.muted}\n`;
                            content += `  - autoplay: ${video.autoplay}\n`;
                            content += `  - loop: ${video.loop}\n`;
                            content += `  - className: ${video.className}\n`;
                            content += `  - style: ${video.style.cssText}\n`;
                            
                            if (video.error) {
                                content += `  - ERROR: ${video.error.message}\n`;
                            }
                        });
                        
                        // Check for hero section
                        const heroSection = doc.querySelector('section');
                        if (heroSection) {
                            content += `\nHero section found: YES\n`;
                            content += `Hero section classes: ${heroSection.className}\n`;
                            
                            // Check for debug info
                            const debugInfo = heroSection.querySelector('[class*="bg-black"]');
                            if (debugInfo) {
                                content += `Debug info: ${debugInfo.textContent}\n`;
                            }
                        } else {
                            content += `\nHero section found: NO\n`;
                        }
                        
                        // Check for loading indicators
                        const loadingElements = Array.from(doc.querySelectorAll('*')).filter(el => 
                            el.textContent && (el.textContent.includes('hero-video') || el.textContent.includes('Loading'))
                        );
                        
                        if (loadingElements.length > 0) {
                            content += `\nLoading indicators found: ${loadingElements.length}\n`;
                            loadingElements.forEach(el => {
                                content += `  - "${el.textContent.substring(0, 100)}..."\n`;
                            });
                        }
                        
                        addSection('üè† Homepage Inspection Results', content, videos.length > 0 ? 'success' : 'warning');
                        
                    } catch (e) {
                        addSection('üè† Homepage Inspection Error', `Error: ${e.message}`, 'error');
                    }
                }, 2000);
            };
            
            resultsDiv.appendChild(iframe);
        }
        
        async function checkVideoCache() {
            addSection('üîÑ Checking Video Cache', 'Checking browser cache systems...');
            
            let content = '';
            
            // Check localStorage
            try {
                const lsKeys = Object.keys(localStorage);
                const videoKeys = lsKeys.filter(key => key.includes('video') || key.includes('hero') || key.includes('cache'));
                content += `LocalStorage keys (${lsKeys.length} total):\n`;
                videoKeys.forEach(key => {
                    const value = localStorage.getItem(key);
                    content += `  - ${key}: ${value ? value.substring(0, 100) + '...' : 'null'}\n`;
                });
                
                if (videoKeys.length === 0) {
                    content += `  No video-related keys found\n`;
                }
            } catch (e) {
                content += `LocalStorage error: ${e.message}\n`;
            }
            
            // Check if IndexedDB is available
            content += `\nIndexedDB available: ${!!window.indexedDB}\n`;
            
            // Check service worker
            content += `Service Worker available: ${!!navigator.serviceWorker}\n`;
            if (navigator.serviceWorker) {
                const registration = await navigator.serviceWorker.getRegistration();
                content += `Service Worker registered: ${!!registration}\n`;
                if (registration) {
                    content += `SW scope: ${registration.scope}\n`;
                    content += `SW state: ${registration.active ? registration.active.state : 'none'}\n`;
                }
            }
            
            addSection('üíæ Cache Status', content);
        }
        
        async function runFullDiagnostic() {
            resultsDiv.innerHTML = '<div class="debug-section"><div class="debug-title">üöÄ Running Full Diagnostic...</div></div>';
            
            await testContentAPI();
            await checkVideoCache();
            await inspectHomepage();
            
            addSection('‚úÖ Diagnostic Complete', 'All checks completed. Review results above.', 'success');
        }
        
        // Auto-run basic diagnostic on load
        window.onload = () => {
            setTimeout(() => {
                testContentAPI();
            }, 500);
        };
    </script>
</body>
</html>